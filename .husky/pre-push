#!/bin/sh

echo "üîç Running ESLint quality gate check..."

# Run ESLint and capture output
LINT_OUTPUT=$(npm run lint 2>&1)
LINT_EXIT_CODE=$?

# Extract problem count from output (format: "‚úñ 22 problems (0 errors, 22 warnings)")
PROBLEM_COUNT=$(echo "$LINT_OUTPUT" | grep "‚úñ" | grep -oE '[0-9]+ problems' | grep -oE '[0-9]+' | head -1 || echo "0")

# Validate and sanitize the count
case "$PROBLEM_COUNT" in
  ''|*[!0-9]*)
    PROBLEM_COUNT=0
    ;;
esac

echo "üìä Current ESLint problems: $PROBLEM_COUNT"

# Block push if problems exceed threshold
THRESHOLD=10
if [ "$PROBLEM_COUNT" -gt "$THRESHOLD" ]; then
  echo ""
  echo "‚ùå PUSH BLOCKED: ESLint violations ($PROBLEM_COUNT) exceed threshold ($THRESHOLD)"
  echo ""
  echo "Please fix ESLint violations before pushing:"
  echo "  npm run lint          # See all violations"
  echo "  npm run lint:fix      # Auto-fix what's possible"
  echo ""
  echo "Current violations exceed the quality gate of $THRESHOLD problems."
  echo "Quality gate reduced from 50 to maintain code quality improvements."
  exit 1
fi

echo "‚úÖ ESLint quality gate passed ($PROBLEM_COUNT/$THRESHOLD problems)"

echo ""
echo "üîç Running TypeScript quality gate check..."

# Run TypeScript check and count errors
TS_OUTPUT=$(npm run typecheck 2>&1 || true)
TS_ERROR_COUNT=$(echo "$TS_OUTPUT" | grep -c "error TS" || echo "0")

# Validate and sanitize the count
case "$TS_ERROR_COUNT" in
  ''|*[!0-9]*)
    TS_ERROR_COUNT=0
    ;;
esac

echo "üìä Current TypeScript errors: $TS_ERROR_COUNT"

# Block push if errors exceed threshold
TS_THRESHOLD=25
if [ "$TS_ERROR_COUNT" -gt "$TS_THRESHOLD" ]; then
  echo ""
  echo "‚ùå PUSH BLOCKED: TypeScript errors ($TS_ERROR_COUNT) exceed threshold ($TS_THRESHOLD)"
  echo ""
  echo "Please fix TypeScript errors before pushing:"
  echo "  npm run typecheck     # See all errors"
  echo ""
  echo "Current errors exceed the quality gate of $TS_THRESHOLD errors."
  echo "Quality gate reduced from 250 to maintain type safety improvements."
  exit 1
fi

echo "‚úÖ TypeScript quality gate passed ($TS_ERROR_COUNT/$TS_THRESHOLD errors)"